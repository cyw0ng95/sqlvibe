# setops.test - Set operation tests (UNION, EXCEPT, INTERSECT)

# ----- Setup -----

statement ok
CREATE TABLE t1 (a INTEGER, b TEXT)

statement ok
CREATE TABLE t2 (a INTEGER, b TEXT)

statement ok
INSERT INTO t1 VALUES (1, 'one')

statement ok
INSERT INTO t1 VALUES (2, 'two')

statement ok
INSERT INTO t1 VALUES (3, 'three')

statement ok
INSERT INTO t2 VALUES (2, 'two')

statement ok
INSERT INTO t2 VALUES (3, 'three')

statement ok
INSERT INTO t2 VALUES (4, 'four')

# ----- UNION (deduplicates) -----

query I rowsort
SELECT a FROM t1 UNION SELECT a FROM t2
----
1
2
3
4

query IT rowsort
SELECT a, b FROM t1 UNION SELECT a, b FROM t2
----
1  one
2  two
3  three
4  four

# ----- UNION ALL (keeps duplicates) -----

query I rowsort
SELECT a FROM t1 UNION ALL SELECT a FROM t2
----
1
2
2
3
3
4

# ----- EXCEPT -----

query I rowsort
SELECT a FROM t1 EXCEPT SELECT a FROM t2
----
1

query I rowsort
SELECT a FROM t2 EXCEPT SELECT a FROM t1
----
4

# ----- INTERSECT -----

query I rowsort
SELECT a FROM t1 INTERSECT SELECT a FROM t2
----
2
3

# ----- Set operations with ORDER BY -----

query I
SELECT a FROM t1 UNION SELECT a FROM t2 ORDER BY a DESC
----
4
3
2
1

query I
SELECT a FROM t1 UNION SELECT a FROM t2 ORDER BY a LIMIT 2
----
1
2

# ----- Set operations with WHERE -----

query I rowsort
SELECT a FROM t1 WHERE a > 1 UNION SELECT a FROM t2 WHERE a < 4
----
2
3

# ----- Set operations on single table -----

query I rowsort
SELECT a FROM t1 WHERE a < 2 UNION SELECT a FROM t1 WHERE a > 2
----
1
3

query I rowsort
SELECT a FROM t1 EXCEPT SELECT a FROM t1 WHERE a = 2
----
1
3

# ----- Empty result set operations -----

statement ok
CREATE TABLE empty (a INTEGER)

query I rowsort
SELECT a FROM t1 UNION SELECT a FROM empty
----
1
2
3

# ----- EXCEPT returning all -----

query I rowsort
SELECT a FROM t1 EXCEPT SELECT a FROM empty
----
1
2
3

# ----- Cleanup -----

statement ok
DROP TABLE t1

statement ok
DROP TABLE t2

statement ok
DROP TABLE empty
