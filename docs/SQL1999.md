# SQL1999 Testsuite Status

**Date**: 2026-02-19 (Updated)
**Version**: v0.6.1 (in progress)
**Total Test Suites**: 25 (E-series + F-series)
**Passing Test Suites**: 10/25 (40%)
**Failing Test Suites**: 15/25 (60%)
**Total Test Failures**: ~416 test cases across failing suites

**Status**: Gap analysis complete, systematic fixes in progress

## Summary by Test Suite

### ✅ Passing Suites (10/25 = 40%)
| Suite | Feature | Status |
|-------|---------|--------|
| E021 | Character String Types | ✅ Complete |
| E081 | Full Query | ✅ Complete |
| E131 | Query Predicates | ✅ Complete |
| E151 | Transaction Support | ✅ Complete |
| E152 | SET TRANSACTION | ✅ Complete |
| E153 | Updatable Queries | ✅ Complete |
| E161 | SQL Comments | ✅ Complete |
| E171 | SQLSTATE | ✅ Complete |
| F021 | Information Schema | ✅ Complete |
| F291 | UNICODE | ✅ Complete |

### ❌ Failing Suites (15/25 = 60%)
| Suite | Feature | Primary Issues |
|-------|---------|----------------|
| E011 | Numeric Data Types | Type coercion, DECIMAL precision |
| E031 | Identifiers | Case sensitivity, table aliases |
| E041 | Schema Definition | DEFAULT values, CHECK constraints |
| E051 | Query Specification | BLOB handling, type coercion |
| E061 | Predicates | LIKE ESCAPE, IN with NULL, ALL/ANY/SOME |
| E101 | Query Expressions | DISTINCT, set operations |
| E111 | Table Creation | Constraint validation |
| E121 | Schema Manipulation | ALTER TABLE not implemented |
| E141 | NULL Handling | NULL propagation in expressions |
| F031 | Schema Manipulation | VIEW not persisted, ALTER TABLE |
| F041 | Joined Tables | Complex JOINs, table aliases |
| F051 | Date and Time | Date functions, ORDER BY |
| F081 | UNION | Set operations edge cases |
| F201 | CAST Function | CAST with precision, type conversion |
| F301 | DEFAULT VALUES | DEFAULT in INSERT, column defaults |

## Running Tests

```bash
# Run all SQL1999 tests (no debug output)
go test ./internal/TS/SQL1999/... -timeout 5m

# Run specific suite
go test ./internal/TS/SQL1999/E011/... -v

# Count passing/failing suites
go test ./internal/TS/SQL1999/... 2>&1 | grep -E "^(ok|FAIL)" | wc -l
```

## Detailed Gap Analysis (2026-02-19)

### Critical Gaps (Blocking Multiple Test Suites)

#### 1. **DEFAULT Values in Column Definitions** (affects E041, F301)
- **Issue**: Parser doesn't handle `DEFAULT` keyword in CREATE TABLE
- **Example**: `CREATE TABLE t1 (id INTEGER, val INTEGER DEFAULT 42)`
- **Impact**: 30+ test failures
- **Error**: `expected ')' after column definition` or DEFAULT ignored
- **Fix needed**: Parser support for column DEFAULT clause

#### 2. **CHECK Constraints** (affects E041, E111)
- **Issue**: CHECK constraints not parsed or enforced
- **Example**: `CREATE TABLE t1 (age INTEGER CHECK (age >= 18))`
- **Impact**: 15+ test failures
- **Error**: Constraint violations not caught (sqlvibe accepts, sqlite rejects)
- **Fix needed**: Parse CHECK, validate on INSERT/UPDATE

#### 3. **BLOB Type Handling** (affects E041, E051)
- **Issue**: BLOB columns return NULL instead of binary data
- **Example**: `SELECT blob_col FROM t1` returns `<nil>` not `[1 2 3]`
- **Impact**: 20+ test failures
- **Error**: `row 0, col 0 mismatch: sqlvibe=<nil>, sqlite=[1 2 3] ([]uint8)`
- **Fix needed**: Store and return binary data correctly

#### 4. **VIEW Persistence** (affects F031)
- **Issue**: VIEWs are created but not stored/queryable
- **Example**: `CREATE VIEW v1 AS SELECT * FROM t1; SELECT * FROM v1;`
- **Impact**: 25+ test failures
- **Error**: `table not found: v1`
- **Fix needed**: Store VIEW definitions in schema, execute on query

#### 5. **ALTER TABLE Operations** (affects E121, F031)
- **Issue**: ALTER TABLE RENAME not implemented
- **Example**: `ALTER TABLE t1 RENAME TO t1_renamed`
- **Impact**: 10+ test failures
- **Error**: `table not found: t1_renamed`
- **Fix needed**: Implement ALTER TABLE RENAME TABLE/COLUMN

### Medium Priority Gaps

#### 6. **Case-Insensitive Table Names** (affects E031)
- **Issue**: Table names are case-sensitive (should be case-insensitive)
- **Example**: Creating `MyTable`, `mytable`, `MYTABLE` as different tables
- **Impact**: 10+ test failures
- **Error**: `table mytable already exists` (in SQLite, not sqlvibe)
- **Fix needed**: Normalize table/column names to lowercase

#### 7. **CAST with Precision/Scale** (affects F201)
- **Issue**: CAST doesn't support `DECIMAL(10,2)` syntax
- **Example**: `CAST(val AS DECIMAL(10,2))`
- **Impact**: 15+ test failures
- **Error**: `expected ')' after CAST type`
- **Fix needed**: Parse precision/scale in CAST expressions

#### 8. **LIKE with ESCAPE** (affects E061)
- **Issue**: LIKE ESCAPE clause behavior incorrect
- **Example**: `name LIKE '%\%%' ESCAPE '\'`
- **Impact**: 5+ test failures
- **Error**: Wrong rows returned (sqlvibe=1, sqlite=0)
- **Fix needed**: Correct ESCAPE character handling

#### 9. **ALL/ANY/SOME Subquery Predicates** (affects E061)
- **Issue**: ALL/ANY/SOME with subqueries not implemented
- **Example**: `SELECT * FROM t1 WHERE a > ALL (SELECT b FROM t2)`
- **Impact**: 10+ test failures
- **Error**: SQLite syntax error (these aren't standard SQLite)
- **Fix needed**: Note - SQLite doesn't support these either, may skip

#### 10. **Complex JOIN Scenarios** (affects F041)
- **Issue**: Multiple JOINs with aliases fail
- **Example**: Self-joins, 3+ table joins with aliases
- **Impact**: 30+ test failures
- **Error**: Wrong row counts, table not found errors
- **Fix needed**: Fix table alias resolution in complex JOINs

### Low Priority / Edge Cases

11. **DISTINCT with expressions** (E101) - 5 failures
12. **Date/Time functions** (F051) - 1-2 failures  
13. **UNION edge cases** (F081) - 10 failures
14. **NULL in IN clauses** (E061) - 3 failures
15. **Column aliases in GROUP BY** (E031) - 5 failures

## Priority Fix Order

Based on impact and dependencies:

1. **Phase 1**: DEFAULT values + CHECK constraints (45+ failures)
2. **Phase 2**: BLOB handling (20+ failures)
3. **Phase 3**: VIEW persistence (25+ failures)
4. **Phase 4**: Case insensitivity (10+ failures)
5. **Phase 5**: CAST precision (15+ failures)
6. **Phase 6**: Complex JOINs (30+ failures)
7. **Phase 7**: ALTER TABLE RENAME (10+ failures)
8. **Phase 8**: Edge cases (30+ failures)

**Total addressable**: ~185 of 416 failures in first 7 phases

## Notes

- Some test failures are for features SQLite doesn't support (ALL/ANY/SOME, UNIQUE predicate, MATCH)
- These should be marked as "not applicable" rather than failures
- Tests use comparison against real SQLite for validation
- Debug output has been cleaned up for easier analysis
