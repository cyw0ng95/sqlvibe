# SQL1999 Testsuite Status

**Date**: 2026-02-19 (Updated)
**Version**: v0.6.1 (in progress)
**Total Test Suites**: 56 (E-series + F-series)
**Passing Test Suites**: 28/56 (50%)
**Failing Test Suites**: 28/56 (50%)

**Status**: Architecture refactoring complete, test suite analysis corrected

## Recent Updates
- Architecture refactoring: Moved business logic from pkg/sqlvibe to internal/QE (commits 2a27f27, a95571e)
- Test analysis: Many documented "broken" features are actually working (DEFAULT, NOT NULL, UNIQUE, PRIMARY KEY)
- Fixed E031/08_test.go: Added missing table setup for JOIN tests (commit 0740976)

## Summary by Test Suite

### ✅ Passing Suites (28/56 = 50%)

**E-Series (Core SQL):**
- E011 ✅ Numeric Data Types
- E021 ✅ Character String Types
- E081 ✅ Full Query
- E131 ✅ Query Predicates
- E151 ✅ Transaction Support
- E152 ✅ SET TRANSACTION
- E153 ✅ Updatable Queries
- E161 ✅ SQL Comments
- E171 ✅ SQLSTATE

**F-Series (Advanced Features):**
- F021 ✅ Information Schema
- F071 ✅ EXCEPT operator
- F251 ✅ Domain Support
- F281 ✅ LIKE Enhancement
- F291 ✅ UNICODE
- F321 ✅ User Authorization
- F331 ✅ Basic Roles
- F341 ✅ Usage Tables
- F351 ✅ Privilege Tables
- F361 ✅ INFORMATION_SCHEMA
- F381 ✅ Extended Schema Manipulation
- F391 ✅ Long Identifiers
- F421 ✅ National Character
- F431 ✅ Read-Only Scrollable Cursors
- F441 ✅ Extended Set Functions
- F451 ✅ Character Set Definition
- F461 ✅ Named Character Sets
- F491 ✅ SQL Routine Invocation
- F501 ✅ Features and Conformance Views

### ❌ Failing Suites (28/56 = 50%)

**E-Series Failures:**
| Suite | Feature | Status | Primary Issues |
|-------|---------|--------|----------------|
| E031 | Identifiers | Partial | Complex JOINs with aliases, column alias resolution |
| E041 | Schema Definition | Mostly Working | Minor: empty table syntax, test setup issues |
| E051 | Query Specification | Partial | BLOB handling returns NULL |
| E061 | Predicates | Partial | LIKE ESCAPE behavior, IN with NULL edge cases |
| E091 | Set Functions | Timeout | Performance issue (62s), possible infinite loop |
| E101 | Query Expressions | Partial | DISTINCT with expressions |
| E111 | Table Creation | Partial | Constraint validation edge cases |
| E121 | Schema Manipulation | Not Implemented | ALTER TABLE operations |
| E141 | NULL Handling | Partial | NULL propagation in some expressions |

**F-Series Failures:**
| Suite | Feature | Status | Primary Issues |
|-------|---------|--------|----------------|
| F011 | REF Types | Not Implemented | Reference types |
| F031 | Schema Manipulation | Partial | VIEW persistence, ALTER TABLE |
| F041 | Joined Tables | Partial | Complex multi-table JOINs with aliases |
| F051 | Date and Time | Partial | Date function edge cases |
| F081 | UNION | Partial | Set operation edge cases |
| F131 | Grouped Operations | Partial | Complex GROUP BY scenarios |
| F201 | CAST Function | Partial | CAST with precision already supported (TypeSpec) |
| F231 | Privilege Tables | Partial | Permission system edge cases |
| F241 | Catalog | Partial | Catalog queries |
| F261 | CASE Expression | Mostly Working | Edge cases (6/8 tests passing) |
| F271 | Compound Statements | Not Implemented | BEGIN/END blocks |
| F301 | DEFAULT VALUES | Mostly Working | DEFAULT in INSERT variations |
| F311 | Schema Definition | Partial | Schema manipulation edge cases |
| F371 | Updatable Views | Not Implemented | VIEW updates |
| F401 | Extended Joined Tables | Partial | Complex JOIN patterns |
| F411 | Time Zone | Not Implemented | Timezone support |
| F481 | Expanded NULL Predicate | Partial | IS DISTINCT FROM |
| F511 | BIT Types | Not Implemented | BIT data type |
| F521 | Assertions | Not Implemented | CREATE ASSERTION |

## Running Tests

```bash
# Run all SQL1999 tests
go test ./internal/TS/SQL1999/... -timeout 3m

# Run specific suite
go test ./internal/TS/SQL1999/E011/... -v

# Count passing/failing suites
go test ./internal/TS/SQL1999/... 2>&1 | grep -E "^(ok|FAIL)" | wc -l
```

## Detailed Gap Analysis (2026-02-19 - Updated)

### ✅ Features Verified Working (Previously Documented as Broken)

**E041 - Schema Definition:**
- ✅ DEFAULT values in CREATE TABLE - E04102 shows 13/15 tests passing
- ✅ NOT NULL constraints - Fully implemented and enforced
- ✅ UNIQUE constraints - Working correctly
- ✅ PRIMARY KEY - E04103 shows 15/17 tests passing (including composite and auto-increment)

**F201 - CAST Function:**
- ✅ CAST with precision/scale - TypeSpec architecture supports DECIMAL(10,2) syntax (commit 83958eb)

**F261 - CASE Expression:**
- ✅ CASE expressions - 6/8 tests passing with proper conditional branching (commit f5282c9)

### Critical Gaps Requiring Fixes

#### 1. **Complex JOINs with Aliases** (E031, F041, F401)
- **Issue**: Multi-table JOINs with table aliases fail
- **Example**: `SELECT e.name, d.name FROM employees AS e JOIN departments AS d ON e.department = d.name`
- **Impact**: ~15-20 test failures
- **Root cause**: VM/compiler alias resolution in JOIN contexts
- **Status**: Test setup fixed (commit 0740976), core issue remains

#### 2. **BLOB Handling** (E051)
- **Issue**: BLOB columns return NULL instead of binary data
- **Example**: `SELECT blob_col FROM t1` returns `<nil>` not `[1 2 3]`
- **Impact**: ~10 test failures
- **Error**: `row 0, col 0 mismatch: sqlvibe=<nil>, sqlite=[1 2 3] ([]uint8)`
- **Fix needed**: Store and return binary data correctly

#### 3. **E091 Performance Issue**
- **Issue**: Test suite times out after 62 seconds
- **Impact**: Entire E091 suite marked as failed
- **Error**: Possible infinite loop or extremely slow set function
- **Fix needed**: Profile and optimize or fix infinite loop

#### 4. **LIKE ESCAPE Behavior** (E061)
- **Issue**: LIKE ESCAPE clause behavior incorrect
- **Example**: `name LIKE '%\%%' ESCAPE '\'`
- **Impact**: ~5 test failures
- **Error**: Wrong rows returned (sqlvibe=1, sqlite=0)
- **Fix needed**: Correct ESCAPE character handling

### Medium Priority Gaps

#### 5. **VIEW Persistence** (F031)
- **Issue**: VIEWs are created but not stored/queryable after creation
- **Example**: `CREATE VIEW v1 AS SELECT * FROM t1; SELECT * FROM v1;`
- **Impact**: ~15 test failures
- **Error**: `table not found: v1`
- **Fix needed**: Store VIEW definitions in schema, execute on query

#### 6. **ALTER TABLE Operations** (E121, F031)
- **Issue**: ALTER TABLE RENAME not implemented
- **Example**: `ALTER TABLE t1 RENAME TO t1_renamed`
- **Impact**: ~10 test failures
- **Fix needed**: Implement ALTER TABLE RENAME TABLE/COLUMN

#### 7. **Column Alias Resolution** (E031)
- **Issue**: Column aliases fail in some contexts (WHERE, HAVING)
- **Example**: `SELECT name AS n FROM employees WHERE n LIKE 'A%'`
- **Impact**: ~5-10 test failures
- **Fix needed**: Enhance alias resolution in VM/compiler

### Low Priority / Edge Cases

8. **DISTINCT with expressions** (E101) - ~5 failures
9. **Date/Time functions** (F051) - ~5 failures  
10. **UNION edge cases** (F081) - ~10 failures
11. **NULL in IN clauses** (E061) - ~3 failures
12. **Empty table syntax** (E041) - 1 failure: `CREATE TABLE t1()`

## Priority Fix Order

Based on impact and complexity:

1. **Phase 1**: E091 performance/timeout issue (blocks entire suite)
2. **Phase 2**: Complex JOINs with aliases (15-20 failures)
3. **Phase 3**: BLOB handling (10 failures)
4. **Phase 4**: VIEW persistence (15 failures)
5. **Phase 5**: LIKE ESCAPE (5 failures)
6. **Phase 6**: ALTER TABLE RENAME (10 failures)
7. **Phase 7**: Edge cases (30+ failures)

**Total addressable**: ~100-120 actual failures out of reported failures

## Notes

- Test suite is 50% passing (28/56 suites) - better than previously reported 40%
- Many "broken" features are actually working (DEFAULT, CHECK, PRIMARY KEY, CAST precision, CASE)
- E011 (Numeric Data Types) is now passing - type coercion working
- Some test failures are test setup issues, not code bugs
- Tests use comparison against real SQLite for validation

