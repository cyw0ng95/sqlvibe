# SQL1999 Testsuite Status

**Date**: 2026-02-20 (Updated)
**Version**: v0.6.2 (in progress)
**Total Test Suites**: 56 (E-series + F-series)
**Passing Test Suites**: 56/56 (100%)
**Failing Test Suites**: 0/56 (0%)

## Recent Updates (2026-02-20) - Round 4

Improvements raising pass rate from 54/56 (96.4%) to **56/56 (100%)**:

- **E041** (now passing): `CompareQueryResults` now sorts both result sets lexicographically when the query has no ORDER BY clause. Row ordering is implementation-defined without ORDER BY; SQLite uses an internal index scan that can return different ordering than sqlvibe's insertion order. Both orderings are valid per SQL standard.
- **E101** (now passing): Fixed two bugs:
  - `LIMIT` in subqueries was not applied — `execSelectStmt` (used for `IN (SELECT ...)` subqueries) now delegates to `execVMQuery` which correctly applies ORDER BY + LIMIT via the `extraOrderByCols` mechanism (temporary projection of sort columns, sort, limit, strip).
  - `execSelectStmtWithContext` pre-sorted raw table data before WHERE was applied, causing LIMIT to truncate the wrong rows. Fixed by adding non-projected ORDER BY columns to the projection temporarily, running VM (which applies WHERE), then sort+limit+strip the filtered results. `stmt.Columns` saved/restored to avoid mutating the shared AST node.
- **E121** (maintained): The same ORDER BY+LIMIT fix also resolved the `OrderBySubquery` case where `SELECT id ... WHERE a < 30 ORDER BY a DESC LIMIT 5` was returning 2 rows instead of 4.

## Summary by Test Suite

### ✅ Passing Suites (56/56 = 100%)

**E-Series (Core SQL):**
- E011 ✅ Numeric Data Types
- E021 ✅ Character String Types
- E031 ✅ Identifiers
- E041 ✅ Schema Definition (NEW)
- E051 ✅ Query Specification
- E061 ✅ Predicates
- E081 ✅ Full Query
- E091 ✅ Set Functions (aggregate functions + ALL keyword fix)
- E101 ✅ Query Expressions (NEW)
- E111 ✅ Window Functions
- E121 ✅ Schema Manipulation
- E131 ✅ Query Predicates
- E141 ✅ NULL Handling
- E151 ✅ Transaction Support
- E152 ✅ SET TRANSACTION
- E153 ✅ Updatable Queries
- E161 ✅ SQL Comments
- E171 ✅ SQLSTATE

**F-Series (Advanced Features):**
- F011 ✅ REF Types
- F021 ✅ Information Schema
- F031 ✅ Schema Manipulation
- F041 ✅ Joined Tables (NEW)
- F051 ✅ Date and Time
- F071 ✅ EXCEPT operator
- F081 ✅ UNION
- F131 ✅ Grouped Operations
- F201 ✅ CAST Function (NEW)
- F231 ✅ Privilege Tables
- F241 ✅ Catalog
- F251 ✅ Domain Support
- F261 ✅ CASE Expression
- F281 ✅ LIKE Enhancement
- F291 ✅ UNICODE
- F301 ✅ DEFAULT VALUES
- F311 ✅ Schema Definition
- F321 ✅ User Authorization
- F331 ✅ Basic Roles
- F341 ✅ Usage Tables
- F351 ✅ Privilege Tables
- F361 ✅ INFORMATION_SCHEMA
- F371 ✅ Updatable Views
- F381 ✅ Extended Schema Manipulation
- F391 ✅ Long Identifiers
- F401 ✅ Extended Joined Tables (NATURAL/USING/RIGHT JOIN)
- F411 ✅ Time Zone (NULLS FIRST/LAST)
- F421 ✅ National Character
- F431 ✅ Read-Only Scrollable Cursors
- F441 ✅ Extended Set Functions
- F451 ✅ Character Set Definition
- F461 ✅ Named Character Sets
- F481 ✅ Expanded NULL Predicate (NULLIF, IS DISTINCT FROM)
- F491 ✅ SQL Routine Invocation
- F501 ✅ Features and Conformance Views
- F511 ✅ BIT Types
- F521 ✅ Assertions

### ❌ Failing Suites (0/56 = 0%)

All 56 suites now passing!

## Running Tests

```bash
# Run all SQL1999 tests
go test ./internal/TS/SQL1999/... -timeout 3m

# Run specific suite
go test ./internal/TS/SQL1999/E011/... -v

# Count passing/failing suites
go test ./internal/TS/SQL1999/... 2>&1 | grep -E "^(ok|FAIL)" | sort
```

## Detailed Gap Analysis (2026-02-20)

### ✅ Features Fixed (Previously Documented as Broken)

**JOIN Operations:**
- ✅ JOIN ON condition - fixed with OpIfNot (was broken due to FixupWithPos overwrite)
- ✅ LEFT JOIN - full implementation with null row emission
- ✅ RIGHT JOIN - converted to LEFT JOIN with column reorder
- ✅ NATURAL JOIN / USING JOIN - column deduplication
- ✅ Comma-separated implicit JOIN - `FROM t1 AS a, t2 AS b`

**Schema Operations:**
- ✅ CREATE VIEW / DROP VIEW / SELECT FROM view
- ✅ ALTER TABLE ADD COLUMN / RENAME TO
- ✅ CREATE TABLE IF NOT EXISTS (fixed token checks)
- ✅ CREATE TABLE AS SELECT
- ✅ CREATE TEMPORARY TABLE
- ✅ DROP TABLE/VIEW/INDEX IF EXISTS (fixed token position)
- ✅ Duplicate column name detection in CREATE TABLE
- ✅ Table-level PRIMARY KEY (a, b), UNIQUE, CHECK, FOREIGN KEY constraints

**Data Manipulation:**
- ✅ INSERT...SELECT syntax
- ✅ INSERT defaults: missing columns filled with declared DEFAULT values
- ✅ Composite PK uniqueness check (all PK columns as tuple)
- ✅ CHECK constraint enforcement on INSERT
- ✅ NOT NULL constraint enforcement on INSERT
- ✅ UNIQUE constraint enforcement on INSERT

**Query Features:**
- ✅ Column aliases in SELECT (`SELECT a AS col1`)
- ✅ Column alias resolution in WHERE, GROUP BY, HAVING
- ✅ SELECT ALL keyword
- ✅ Aggregate WHERE clause filtering
- ✅ LIKE ESCAPE clause
- ✅ Doubled single-quote '' escape in strings
- ✅ NULLS FIRST/LAST in ORDER BY
- ✅ NULLIF function
- ✅ TYPEOF/RANDOM/ROUND(val, precision) functions
- ✅ Multi-statement SQL (semicolons)

### Remaining Priority Gaps

1. **E041 SelectFromT1UsingIndex**: Row ordering without ORDER BY — SQLite uses a DESC index scan and returns rows in reverse order; sqlvibe returns insertion order. Both orderings are valid per SQL standard. Fix: add ORDER BY to the test or implement index-based scan ordering.
2. **E101 Complex UPDATEs**: `UpdateOrderBy` with `WHERE id IN (SELECT id FROM ... ORDER BY salary DESC LIMIT 2)` — LIMIT in the IN-subquery may not be correctly applied, causing extra rows to get `salary + 100`. Also `SelectNullBonus` — NULL bonus set by `UpdateWithNull` may be overwritten by a subsequent correlated subquery UPDATE.

## Notes

- Test suite is 96.4% passing (54/56 suites) — significantly improved from 50% baseline
- Tests use comparison against real SQLite for validation
- Compiler logic exclusively in CG package
- Window functions (`OVER` clause) now supported: COUNT/SUM/AVG/MIN/MAX/LAG/LEAD/FIRST_VALUE/LAST_VALUE/ROW_NUMBER/RANK/DENSE_RANK
- Assertions added to all new functions (CG, pkg/sqlvibe) for defensive programming
