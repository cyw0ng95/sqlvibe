# SQL1999 Testsuite Status

**Date**: 2026-02-20 (Updated)
**Version**: v0.6.2 (in progress)
**Total Test Suites**: 56 (E-series + F-series)
**Passing Test Suites**: 49/56 (87.5%)
**Failing Test Suites**: 7/56 (12.5%)

## Recent Updates (2026-02-20) - Round 2

Improvements raising pass rate from 46/56 (82%) to 49/56 (87.5%):

- **E141** (now passing): `INDEXED BY` hint parsed and ignored; INSERT column name validation (table has no column named X); unquoted identifier in VALUES returns "no such column" error.
- **F011** (now passing): INSERT validates explicitly specified column names against table schema.
- **F051** (now passing): Date/time functions implemented — `CURRENT_DATE`, `CURRENT_TIME`, `CURRENT_TIMESTAMP`, `DATE('now')`, `TIME('now')`, `DATETIME('now')`, `STRFTIME()`, date arithmetic modifiers (`+1 day`, `-1 month`, etc.); `CAST(ts AS DATE)` returns leading integer (SQLite NUMERIC affinity behavior); DEFAULT expression evaluation (`DEFAULT (1+1)` now evaluates to 2).
- **OpCallScalar**: New opcode for generic scalar function dispatch at runtime — keywords followed by `(` now parsed as function calls (handles DATE, TIME, DATETIME, STRFTIME, etc.).
- **CAST DATE/TIME**: Both VM `OpCast` and QE `evalCastExpr` now handle DATE/TIME/TIMESTAMP types as NUMERIC affinity (leading-integer parsing).
- **BLOB in INSERT...SELECT**: `literalToString` now converts `[]byte` to `X'hex'` notation so blobs survive re-insertion.

- **Alias resolution**: Column aliases resolved in WHERE, GROUP BY, HAVING (SQLite extension).
- **Comma join**: `FROM t1 AS a, t2 AS b` (implicit CROSS JOIN) now supported.
- **DROP IF EXISTS**: Fixed token position for `IF EXISTS` after `TABLE`/`VIEW`/`INDEX`.
- **sqlite_master**: Includes views and indexes; WHERE supports AND conditions.
- **Aggregate WHERE**: `WhereExpr` correctly threaded through to `AggregateInfo`.
- **Assertions**: Added to all new functions in CG, pkg/sqlvibe for defensive programming.

## Summary by Test Suite

### ✅ Passing Suites (41/56 = 73%)

**E-Series (Core SQL):**
- E011 ✅ Numeric Data Types
- E021 ✅ Character String Types
- E081 ✅ Full Query
- E091 ✅ Set Functions (aggregate functions + ALL keyword fix)
- E131 ✅ Query Predicates
- E151 ✅ Transaction Support
- E152 ✅ SET TRANSACTION
- E153 ✅ Updatable Queries
- E161 ✅ SQL Comments
- E171 ✅ SQLSTATE

**F-Series (Advanced Features):**
- F021 ✅ Information Schema
- F071 ✅ EXCEPT operator
- F081 ✅ UNION
- F131 ✅ Grouped Operations
- F241 ✅ Catalog
- F251 ✅ Domain Support
- F261 ✅ CASE Expression
- F281 ✅ LIKE Enhancement
- F291 ✅ UNICODE
- F301 ✅ DEFAULT VALUES
- F311 ✅ Schema Definition
- F321 ✅ User Authorization
- F331 ✅ Basic Roles
- F341 ✅ Usage Tables
- F351 ✅ Privilege Tables
- F361 ✅ INFORMATION_SCHEMA
- F371 ✅ Updatable Views
- F381 ✅ Extended Schema Manipulation
- F391 ✅ Long Identifiers
- F401 ✅ Extended Joined Tables (NATURAL/USING/RIGHT JOIN)
- F411 ✅ Time Zone (NULLS FIRST/LAST)
- F421 ✅ National Character
- F431 ✅ Read-Only Scrollable Cursors
- F441 ✅ Extended Set Functions
- F451 ✅ Character Set Definition
- F461 ✅ Named Character Sets
- F481 ✅ Expanded NULL Predicate (NULLIF, IS DISTINCT FROM)
- F491 ✅ SQL Routine Invocation
- F501 ✅ Features and Conformance Views
- F511 ✅ BIT Types
- F521 ✅ Assertions

### ❌ Failing Suites (15/56 = 27%)

**E-Series Failures:**
| Suite | Feature | Status | Primary Issues |
|-------|---------|--------|----------------|
| E031 | Identifiers | Partial | Multi-table JOINs with complex alias patterns |
| E041 | Schema Definition | Partial | E04104 JOIN produces too many rows; E04108 index ordering; E04110 JOIN+view; E04112 PRAGMA for CREATE AS SELECT |
| E051 | Query Specification | Partial | BLOB handling returns NULL |
| E061 | Predicates | Partial | ALL/ANY/SOME operators; BETWEEN in GROUP BY |
| E101 | Query Expressions | Partial | UPDATE with subquery numerical precision; DISTINCT expressions |
| E111 | Table Creation | Partial | Single-row SELECT constraints |
| E121 | Schema Manipulation | Partial | ORDER BY expression edge cases |
| E141 | NULL Handling | Partial | NULL propagation in scalar subqueries |

**F-Series Failures:**
| Suite | Feature | Status | Primary Issues |
|-------|---------|--------|----------------|
| F011 | REF Types | Not Implemented | Reference types not supported |
| F031 | Schema Manipulation | Partial | ALTER TABLE with view queries; DROP with RESTRICT; edge cases |
| F041 | Joined Tables | Partial | Complex 3-table JOINs; JOIN with subquery |
| F051 | Date and Time | Partial | Date arithmetic and formatting edge cases |
| F201 | CAST Function | Partial | CastInGroupBy row count; CastPrecision rounding; CastInAggregates NULL result |
| F231 | Privilege Tables | Partial | TableExpression3/4 row count mismatch |
| F271 | Compound Statements | Partial | UnionWithSum causes infinite loop in VM (assertion triggered) |

## Running Tests

```bash
# Run all SQL1999 tests
go test ./internal/TS/SQL1999/... -timeout 3m

# Run specific suite
go test ./internal/TS/SQL1999/E011/... -v

# Count passing/failing suites
go test ./internal/TS/SQL1999/... 2>&1 | grep -E "^(ok|FAIL)" | sort
```

## Detailed Gap Analysis (2026-02-20)

### ✅ Features Fixed (Previously Documented as Broken)

**JOIN Operations:**
- ✅ JOIN ON condition - fixed with OpIfNot (was broken due to FixupWithPos overwrite)
- ✅ LEFT JOIN - full implementation with null row emission
- ✅ RIGHT JOIN - converted to LEFT JOIN with column reorder
- ✅ NATURAL JOIN / USING JOIN - column deduplication
- ✅ Comma-separated implicit JOIN - `FROM t1 AS a, t2 AS b`

**Schema Operations:**
- ✅ CREATE VIEW / DROP VIEW / SELECT FROM view
- ✅ ALTER TABLE ADD COLUMN / RENAME TO
- ✅ CREATE TABLE IF NOT EXISTS (fixed token checks)
- ✅ CREATE TABLE AS SELECT
- ✅ CREATE TEMPORARY TABLE
- ✅ DROP TABLE/VIEW/INDEX IF EXISTS (fixed token position)
- ✅ Duplicate column name detection in CREATE TABLE
- ✅ Table-level PRIMARY KEY (a, b), UNIQUE, CHECK, FOREIGN KEY constraints

**Data Manipulation:**
- ✅ INSERT...SELECT syntax
- ✅ INSERT defaults: missing columns filled with declared DEFAULT values
- ✅ Composite PK uniqueness check (all PK columns as tuple)
- ✅ CHECK constraint enforcement on INSERT
- ✅ NOT NULL constraint enforcement on INSERT
- ✅ UNIQUE constraint enforcement on INSERT

**Query Features:**
- ✅ Column aliases in SELECT (`SELECT a AS col1`)
- ✅ Column alias resolution in WHERE, GROUP BY, HAVING
- ✅ SELECT ALL keyword
- ✅ Aggregate WHERE clause filtering
- ✅ LIKE ESCAPE clause
- ✅ Doubled single-quote '' escape in strings
- ✅ NULLS FIRST/LAST in ORDER BY
- ✅ NULLIF function
- ✅ TYPEOF/RANDOM/ROUND(val, precision) functions
- ✅ Multi-statement SQL (semicolons)

### Remaining Priority Gaps

1. **F271 UnionWithSum**: Infinite loop in VM when executing UNION with aggregate over derived table
2. **E041/04**: JoinOrdersUsers — JOIN produces too many rows
3. **F201 CastPrecision**: DECIMAL rounding in CAST(123.456 AS DECIMAL(5,2)) returns 123.5 vs 123.45
4. **F201 CastInAggregates**: MIN/MAX returning NULL over CAST expressions
5. **E061 ALL/ANY/SOME**: Quantified comparison predicates not implemented
6. **E051 BLOB**: BLOB columns return NULL instead of binary data
7. **F031**: ALTER TABLE interactions with views
8. **F051**: Date arithmetic edge cases

## Notes

- Test suite is 73% passing (41/56 suites) - significantly improved from 50% baseline
- Tests use comparison against real SQLite for validation
- Compiler logic now exclusively in CG package (VM/compiler.go emptied)
- Assertions added to all new functions (CG, pkg/sqlvibe) for defensive programming
